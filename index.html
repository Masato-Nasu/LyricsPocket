<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#0b0e14"/>
<link rel="manifest" href="./manifest.webmanifest">
<title>LyricsPocket</title>
<style>
:root{
  --bg:#0b0e14; --panel:#111827; --panel2:#0f172a; --text:#e5e7eb;
  --muted:#94a3b8; --line:rgba(255,255,255,.10); --accent:#60a5fa;
  --ok:#34d399; --ng:#fb7185;
  --r:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
}
.wrap{max-width:980px; margin:0 auto; padding:14px; padding-bottom:24px}
.h1{font-size:18px; font-weight:700; letter-spacing:.2px}
.small{color:var(--muted); font-size:12px; line-height:1.4}
.pane{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
  border:1px solid var(--line); border-radius:20px; overflow:hidden; margin-top:12px;
}
.head{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; flex-wrap:wrap}
.body{padding:12px 14px}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.btn, .pill{
  display:inline-flex; align-items:center; justify-content:center;
  height:44px; padding:0 14px; border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.03); color:var(--text);
  text-decoration:none; cursor:pointer; user-select:none;
  font-weight:650; letter-spacing:.2px;
}
.btn:active{transform:translateY(1px)}
.btn.primary{background:rgba(96,165,250,.18); border-color:rgba(96,165,250,.35)}
.btn.danger{background:rgba(251,113,133,.15); border-color:rgba(251,113,133,.35)}
.btn.ok{background:rgba(52,211,153,.15); border-color:rgba(52,211,153,.35)}
.btn.disabled{opacity:.45; pointer-events:none}
.pill{height:34px; padding:0 12px; font-size:12px; font-weight:650}
.pill.on{background:rgba(52,211,153,.12); border-color:rgba(52,211,153,.35)}
.pill.off{background:rgba(255,255,255,.02)}
.status{
  padding:10px 12px; border-radius:14px;
  border:1px solid var(--line); background:rgba(0,0,0,.20);
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  font-size:12px; white-space:pre-wrap; line-height:1.35;
}
.list{border-top:1px solid var(--line)}
.itemRow{
  display:flex; gap:10px; align-items:flex-start;
  padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.07);
}
.itemRow.current{background:rgba(255,255,255,.04)}
.itemRow input{margin-top:3px; transform:scale(1.2)}
.itemRow .t{font-size:14px; line-height:1.35; word-break:break-word}
.itemRow .sub{font-size:12px; color:var(--muted); margin-top:3px}
.lyLine{padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.07)}
.lyLine.current{background:rgba(96,165,250,.12)}
.lyLine .en{font-size:14px; line-height:1.4; word-break:break-word}
.lyLine .jp{font-size:13px; line-height:1.4; color:#d1d5db; opacity:.95; margin-top:6px; white-space:pre-wrap}
.hidden{display:none !important}
hr{border:none; border-top:1px solid var(--line); margin:10px 0}
audio{width:100%}
label.btn{gap:8px}
</style>

<script>
/* SW: 古い壊れたSWループから抜けるため、無害SWを上書き登録 */
(function(){
  try{
    if (!("serviceWorker" in navigator)) return;
    navigator.serviceWorker.register("./sw.js", {scope:"./"}).then(function(reg){
      try{ reg.update(); }catch(e){}
    }).catch(function(){});
  }catch(e){}
})();
</script>
</head>
<body>
<div class="wrap">
  <div class="h1">LyricsPocket (STABLE)</div>
  <div class="small">Android/iPhone対応（iOSはフォルダ選択不可） / mp3,m4a + .lrc/.txt を端末から選択して再生・表示</div>

  <div class="pane">
    <div class="head">
      <div class="row" style="flex:1">
        <label for="inAudio" class="btn primary">AUDIOを選ぶ</label>
        <label for="inLyrics" class="btn">LYRICSを選ぶ</label>
        <button id="btnPlay" class="btn ok">PLAY</button>
        <button id="btnPrev" class="btn">PREV</button>
        <button id="btnNext" class="btn">NEXT</button>
        <button id="btnList" class="btn">LIST</button>
        <button id="btnJP" class="pill on" type="button">JP: ON</button>
      </div>
    </div>
    <div class="body">
      <div id="chipTrack" class="pill off" style="display:inline-flex">TRACK: (未選択)</div>
      <div style="height:10px"></div>
      <audio id="audio" controls playsinline></audio>
      <div style="height:10px"></div>
      <div id="status" class="status">READY</div>
      <div style="height:10px"></div>
      <div id="curLine" class="status">EN:
JP:</div>
    </div>

    <div id="panelLists" class="body">
      <div class="small">TRACKS</div>
      <div id="trackList" class="list"></div>
      <div style="height:12px"></div>
      <div class="small">LYRICS</div>
      <div id="lyricList" class="list"></div>
      <div class="small" style="margin-top:10px">曲と歌詞が自動一致しない場合：曲を選んでから、下のLYRICSをタップして切り替えてください（端末に保存します）。</div>
    </div>

    <div id="panelLyrics" class="list"></div>
  </div>

  <div class="pane">
    <div class="head">
      <div style="font-weight:700">SW / リセット</div>
    </div>
    <div class="body">
      <a class="btn danger" href="./kill-sw.html">SW & Cache を消す（白画面対策）</a>
      <div class="small" style="margin-top:10px">※ 反映がおかしい／真っ白になる場合は、上のボタン→戻る→再読み込み。</div>
    </div>
  </div>

  <input id="inAudio" type="file" accept="audio/*,.mp3,.m4a,.aac,.wav,.flac,.ogg" multiple
         style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;opacity:0" />
  <input id="inLyrics" type="file" accept=".lrc,.txt,text/plain" multiple
         style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;opacity:0" />
</div>

<script>
"use strict";

function $(id){ return document.getElementById(id); }
var inAudio = $("inAudio");
var inLyrics = $("inLyrics");
var audioEl = $("audio");
var statusEl = $("status");
var curLineEl = $("curLine");
var chipTrack = $("chipTrack");
var trackListEl = $("trackList");
var lyricListEl = $("lyricList");
var panelLists = $("panelLists");
var panelLyrics = $("panelLyrics");

var btnPlay = $("btnPlay");
var btnPrev = $("btnPrev");
var btnNext = $("btnNext");
var btnList = $("btnList");
var btnJP = $("btnJP");

var tracks = []; // {name, url, file}
var trackIndex = -1;

var lyricsMap = new Map(); // key -> {name,text,lines}
var linkMap = loadLinkMap(); // trackKey -> lyricKey

var currentLines = []; // active lyric lines
var currentLineIndex = -1;
var jpOn = true;
var listOn = true;

function setStatus(t){
  statusEl.textContent = String(t);
}
function setCur(en, jp){
  curLineEl.textContent = "EN: " + (en||"") + "\nJP: " + (jp||"");
}

function baseName(name){
  var n = String(name||"");
  n = n.replace(/\.[^\.]+$/,"");
  return n;
}
function normalizeKey(name){
  var s = String(name||"").toLowerCase();
  s = s.replace(/\.[^\.]+$/,"");
  s = s.replace(/\(.*?\)|\[.*?\]|\{.*?\}/g," ");
  s = s.replace(/\b(remaster(ed)?|mono|stereo|live|demo|version|edit|mix|feat\.?|ft\.?|official|audio|lyrics?)\b/g," ");
  s = s.replace(/[^a-z0-9\u3040-\u30ff\u4e00-\u9faf]+/g," ");
  s = s.replace(/\s+/g," ").trim();
  return s;
}

function loadLinkMap(){
  try{
    var raw = localStorage.getItem("lp_link_map_stable");
    if (!raw) return new Map();
    var obj = JSON.parse(raw);
    return new Map(Object.entries(obj||{}));
  }catch(e){ return new Map(); }
}
function saveLinkMap(){
  try{
    var obj = Object.fromEntries(linkMap.entries());
    localStorage.setItem("lp_link_map_stable", JSON.stringify(obj));
  }catch(e){}
}

function clearTracks(){
  for (var i=0;i<tracks.length;i++){
    try{ URL.revokeObjectURL(tracks[i].url); }catch(e){}
  }
  tracks = [];
  trackIndex = -1;
}

function parseLRC(text){
  // returns [{t:number|null, en:string, jp:string|null}]
  var s = String(text||"");
  s = s.replace(/\r/g,"");
  var lines = s.split("\n");
  var out = [];
  var hasTime = false;

  for (var i=0;i<lines.length;i++){
    var line = lines[i];
    if (!line) continue;
    var m = line.match(/\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g);
    if (m){
      hasTime = true;
      var plain = line.replace(/\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g,"").trim();
      if (!plain) continue;
      for (var j=0;j<m.length;j++){
        var mm = /\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/.exec(m[j]);
        if (!mm) continue;
        var min = parseInt(mm[1],10)||0;
        var sec = parseInt(mm[2],10)||0;
        var ms = mm[3] ? parseInt((mm[3]+"00").slice(0,3),10) : 0;
        var t = min*60 + sec + ms/1000;
        out.push({t:t, en:plain, jp:null});
      }
    }else{
      var p = line.trim();
      if (!p) continue;
      out.push({t:null, en:p, jp:null});
    }
  }
  if (hasTime){
    out.sort(function(a,b){ return a.t-b.t; });
  }
  return out;
}

function renderTrackList(){
  trackListEl.innerHTML = "";
  if (!tracks.length){
    trackListEl.innerHTML = '<div class="itemRow"><div class="t" style="opacity:.75">AUDIOを選ぶ で曲を選択してください。</div></div>';
    return;
  }
  for (var i=0;i<tracks.length;i++){
    var t = tracks[i];
    var lab = document.createElement("label");
    lab.className = "itemRow" + (i===trackIndex ? " current":"");
    var safeName = escapeHTML(t.name);
    lab.innerHTML = '<input type="radio" name="trk" value="'+i+'" '+(i===trackIndex?'checked':'')+'>' +
                    '<div><div class="t">'+safeName+'</div><div class="sub">'+(i+1)+' / '+tracks.length+'</div></div>';
    trackListEl.appendChild(lab);
  }
}

function renderLyricList(){
  lyricListEl.innerHTML = "";
  var keys = Array.from(lyricsMap.keys());
  if (!keys.length){
    lyricListEl.innerHTML = '<div class="itemRow"><div class="t" style="opacity:.75">LYRICSを選ぶ で .lrc/.txt を選択してください。</div></div>';
    return;
  }
  for (var i=0;i<keys.length;i++){
    var k = keys[i];
    var info = lyricsMap.get(k);
    var lab = document.createElement("label");
    lab.className = "itemRow";
    lab.innerHTML = '<input type="radio" name="lyr" value="'+escapeHTML(k)+'">' +
                    '<div><div class="t">'+escapeHTML(info.name)+'</div><div class="sub">'+k+'</div></div>';
    lyricListEl.appendChild(lab);
  }
}

function selectTrack(i){
  if (!(i>=0 && i<tracks.length)) return;
  trackIndex = i;
  var tr = tracks[i];
  chipTrack.textContent = "TRACK: " + tr.name;
  chipTrack.className = "pill on";
  // auto link lyric if exists
  autoPickLyricsForTrack(tr.name);
  // set audio source but do not autoplay
  audioEl.src = tr.url;
  audioEl.load();
  renderTrackList();
  setStatus("TRACK READY: " + tr.name);
}

function autoPickLyricsForTrack(trackName){
  var tkey = normalizeKey(trackName);
  var linked = linkMap.get(tkey);
  if (linked && lyricsMap.has(linked)){
    loadLyricsKey(linked);
    return;
  }
  // exact base name
  var b = baseName(trackName);
  var bkey = normalizeKey(b);
  var bestKey = null;
  var bestScore = -1;
  lyricsMap.forEach(function(val,key){
    var lk = normalizeKey(val.name);
    if (lk === bkey){ bestKey = key; bestScore = 999; return; }
    // partial overlap
    var score = 0;
    if (lk && bkey){
      if (lk.indexOf(bkey)>=0 || bkey.indexOf(lk)>=0) score = Math.min(lk.length,bkey.length);
    }
    if (score > bestScore){
      bestScore = score;
      bestKey = key;
    }
  });
  if (bestKey){
    // save mapping for next time
    linkMap.set(tkey, bestKey);
    saveLinkMap();
    loadLyricsKey(bestKey);
  }else{
    currentLines = [];
    currentLineIndex = -1;
    renderLyricsLines();
    setStatus("LYRICS: NO MATCH (下のLYRICSから選んでください)");
  }
}

function loadLyricsKey(key){
  var info = lyricsMap.get(key);
  if (!info) return;
  currentLines = info.lines;
  currentLineIndex = -1;
  renderLyricsLines();
  setStatus("LYRICS LOADED: " + info.name + " (" + currentLines.length + " lines)");
  // if no timestamp lyrics, show first line and translate it
  if (currentLines.length && currentLines[0].t === null){
    currentLineIndex = 0;
    highlightLine(0);
    maybeTranslateLine(0);
  }
}

function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, function(c){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
  });
}

function renderLyricsLines(){
  panelLyrics.innerHTML = "";
  if (!currentLines.length){
    panelLyrics.innerHTML = '<div class="lyLine"><div class="en" style="opacity:.75">歌詞がありません。LYRICSを選ぶ で .lrc/.txt を読み込むか、下のLYRICSから選択してください。</div></div>';
    setCur("",""); 
    return;
  }
  for (var i=0;i<currentLines.length;i++){
    var ln = currentLines[i];
    var div = document.createElement("div");
    div.className = "lyLine" + (i===currentLineIndex ? " current":"");
    div.dataset.i = String(i);
    div.innerHTML = '<div class="en">'+escapeHTML(ln.en)+'</div>' +
                    '<div class="jp">'+escapeHTML(ln.jp || "")+'</div>';
    panelLyrics.appendChild(div);
  }
}

function highlightLine(i){
  currentLineIndex = i;
  var nodes = panelLyrics.querySelectorAll(".lyLine");
  for (var k=0;k<nodes.length;k++){
    nodes[k].classList.toggle("current", k===i);
    var jp = nodes[k].querySelector(".jp");
    if (jp && !jpOn) jp.textContent = "";
    if (jp && jpOn) jp.textContent = currentLines[k].jp || "";
  }
  var ln = currentLines[i];
  setCur(ln.en, ln.jp || "");
  // ensure visible
  var cur = panelLyrics.querySelector(".lyLine.current");
  if (cur && cur.scrollIntoView){
    cur.scrollIntoView({block:"center", behavior:"smooth"});
  }
}

function findLineIndexByTime(t){
  // assumes sorted by t
  var last = -1;
  for (var i=0;i<currentLines.length;i++){
    var lt = currentLines[i].t;
    if (lt === null) return -1;
    if (lt <= t) last = i;
    else break;
  }
  return last;
}

function maybeTranslateLine(i){
  if (!jpOn) return;
  if (!(i>=0 && i<currentLines.length)) return;
  var ln = currentLines[i];
  if (!ln.en) return;
  if (ln.jp) return;
  // call MyMemory (no key)
  var q = ln.en.trim();
  if (!q) return;
  setStatus("TRANSLATING...");
  fetch("https://api.mymemory.translated.net/get?q="+encodeURIComponent(q)+"&langpair=en|ja")
    .then(function(r){ return r.json(); })
    .then(function(j){
      var txt = "";
      try{ txt = (j && j.responseData && j.responseData.translatedText) ? String(j.responseData.translatedText) : ""; }catch(e){}
      if (!txt) txt = "";
      ln.jp = txt;
      // update line UI
      var el = panelLyrics.querySelector('.lyLine[data-i="'+i+'"] .jp');
      if (el && jpOn) el.textContent = ln.jp || "";
      setCur(ln.en, ln.jp || "");
      setStatus("OK");
    })
    .catch(function(){
      setStatus("TRANSLATE FAILED (OPENでGoogle翻訳へ)");
    });
}

function toggleJP(){
  jpOn = !jpOn;
  btnJP.textContent = "JP: " + (jpOn ? "ON" : "OFF");
  btnJP.className = "pill " + (jpOn ? "on" : "off");
  if (!currentLines.length) return;
  // refresh current
  if (currentLineIndex>=0) highlightLine(currentLineIndex);
}

function toggleList(){
  listOn = !listOn;
  panelLists.classList.toggle("hidden", !listOn);
}

inAudio.addEventListener("change", function(){
  try{
    clearTracks();
    var files = Array.from(inAudio.files || []);
    files = files.filter(function(f){
      var n = (f.name||"").toLowerCase();
      return /\.(mp3|m4a|aac|wav|flac|ogg)$/i.test(n);
    });
    for (var i=0;i<files.length;i++){
      var f = files[i];
      var url = URL.createObjectURL(f);
      tracks.push({name:f.name, url:url, file:f});
    }
    setStatus("AUDIO LOADED: " + tracks.length);
    renderTrackList();
    if (tracks.length){
      selectTrack(0);
    }
  }catch(e){
    setStatus("AUDIO ERROR: " + String(e));
  }finally{
    // allow selecting same file again
    inAudio.value = "";
  }
});

inLyrics.addEventListener("change", function(){
  var files = Array.from(inLyrics.files || []);
  if (!files.length){ inLyrics.value=""; return; }
  var left = files.length;
  setStatus("LYRICS LOADING...");
  files.forEach(function(f){
    var reader = new FileReader();
    reader.onload = function(){
      try{
        var text = String(reader.result||"");
        var key = normalizeKey(f.name);
        var lines = parseLRC(text);
        lyricsMap.set(key, {name:f.name, text:text, lines:lines});
      }catch(e){}
      left--;
      if (left<=0){
        setStatus("LYRICS READY: " + lyricsMap.size);
        renderLyricList();
        // if track selected, try auto pick
        if (trackIndex>=0 && tracks[trackIndex]){
          autoPickLyricsForTrack(tracks[trackIndex].name);
        }
      }
    };
    reader.onerror = function(){
      left--;
      if (left<=0){
        setStatus("LYRICS READY: " + lyricsMap.size);
        renderLyricList();
      }
    };
    reader.readAsText(f);
  });
  inLyrics.value = "";
});

// Track selection (radio)
trackListEl.addEventListener("change", function(e){
  var t = e.target;
  if (!t || t.name!=="trk") return;
  var i = parseInt(t.value,10);
  if (!isFinite(i)) return;
  selectTrack(i);
});

// Lyric selection (radio): save mapping and load
lyricListEl.addEventListener("change", function(e){
  var t = e.target;
  if (!t || t.name!=="lyr") return;
  var key = String(t.value||"");
  if (!lyricsMap.has(key)) return;
  if (trackIndex>=0 && tracks[trackIndex]){
    linkMap.set(normalizeKey(tracks[trackIndex].name), key);
    saveLinkMap();
  }
  loadLyricsKey(key);
});

// Tap line to translate
panelLyrics.addEventListener("click", function(e){
  var el = e.target;
  var row = el && el.closest ? el.closest(".lyLine") : null;
  if (!row) return;
  var i = parseInt(row.dataset.i,10);
  if (!isFinite(i)) return;
  highlightLine(i);
  maybeTranslateLine(i);
});

btnPlay.addEventListener("click", function(){
  if (trackIndex<0 && tracks.length) selectTrack(0);
  if (!audioEl.src){
    setStatus("NO TRACK");
    return;
  }
  audioEl.play().then(function(){
    setStatus("PLAYING");
  }).catch(function(err){
    setStatus("PLAY BLOCKED: " + String(err && err.name ? err.name : err));
  });
});

btnPrev.addEventListener("click", function(){
  if (!tracks.length) return;
  var i = trackIndex<=0 ? tracks.length-1 : trackIndex-1;
  selectTrack(i);
});

btnNext.addEventListener("click", function(){
  if (!tracks.length) return;
  var i = (trackIndex>=tracks.length-1) ? 0 : trackIndex+1;
  selectTrack(i);
});

btnList.addEventListener("click", toggleList);
btnJP.addEventListener("click", toggleJP);

// follow lyrics with time
audioEl.addEventListener("timeupdate", function(){
  if (!currentLines.length) return;
  if (!currentLines[0] || currentLines[0].t===null) return; // no time
  var t = audioEl.currentTime || 0;
  var idx = findLineIndexByTime(t);
  if (idx>=0 && idx!==currentLineIndex){
    highlightLine(idx);
    maybeTranslateLine(idx);
  }
});

// initial UI
setStatus("JS OK (STABLE)");
renderTrackList();
renderLyricList();
</script>
</body>
</html>
